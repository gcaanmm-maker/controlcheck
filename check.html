<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Checklist Diário</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
/* Estilos Essenciais para o Checklist */
body { font-family: Arial; margin:0; background:#f0f2f5; }

/* 1. REGRA 'header' MODIFICADA PARA CENTRALIZAR */
header {
    background:#007bff;
    color:white;
    padding:20px;
    font-size:20px;
    /* Adicionado para centralizar */
    display: flex;
    align-items: center;
    justify-content: center;
}

/* 2. REGRA '#header-logo' MODIFICADA (removida margin-right) */
#header-logo {
    height: 80px; /* Tamanho original mantido */
    width: auto;
    /* margin-right: 10px; <-- Removido daqui */
}
.container { padding:10px; max-width: 600px; margin: 20px auto; background: white; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
h2 { color: #007bff; text-align: center; }
label { display: block; margin-top: 10px; font-weight: bold; }
input[type="text"], select { width:100%; padding:8px; margin:5px 0 15px 0; border-radius:5px; border:1px solid #ccc; box-sizing: border-box; }
button { padding:10px 15px; border-radius:8px; margin-top:15px; cursor:pointer; background:#28a745; color:white; border:none; width: 100%; }
button:hover { background:#1e7e34; }

/* Estilos de Câmera e Fotos */
.camera-control-area {
    width: 100%;
    max-width: 300px;
    margin: 10px 0; 
}
video { border-radius:10px; margin-top:10px; width:100%; max-width:300px; display:block; } 
.botoes-foto-container {
    display: flex;
    gap: 10px; 
    margin-top: 10px;
}
.botoes-foto-container button {
    flex: 1; 
    padding: 10px;
    margin: 0; 
}
.foto-preview { width:100%; max-width:300px; margin-top:10px; display:block; border:2px solid green; border-radius:10px; }
.foto-confirm { color:green; font-weight:bold; display:none; }

/* 3. REGRAS ADICIONADAS para agrupar e estilizar o conteúdo do header */
.header-content {
    display: flex;
    align-items: center;
}
.header-content span {
    font-weight: bold;
    font-size: 1.2em; /* Tamanho original mantido */
    white-space: nowrap;
    margin-left: 10px; /* Espaçamento mantido */
}

/* === NOVA REGRA CSS PARA O BOTÃO DE TROCAR CÂMERA === */
#trocarCamera {
    background: #007bff;
    color: white;
    width: auto; /* Tamanho automático */
    padding: 8px 12px;
    margin-bottom: 10px; /* Espaço antes do vídeo */
    margin-top: 0;
}

/* 4. REGRA ADICIONADA para melhorar visualização mobile */
@media (max-width: 600px) {
    .container {
        margin: 0;
        padding-top: 10px;
        padding-bottom: 20px;
        border-radius: 0;
        box-shadow: none;
    }
}
</style>
</head>
<body onload="carregarChecklist()">

<header>
    <div class="header-content">
        <img src=imagens/logo.png" alt="Logomarca" id="header-logo">
        <span>ControlCheck2</span>
    </div>
</header>

    <div id="checklist" class="container">
        <h2>Checklist Diário</h2>
        
        <label for="localChecklist">Local do Checklist:</label>
        <select id="localChecklist" onchange="filtrarFerramentasPorLocal()"><option value="">Selecione o Local</option></select>
        
        <label for="responsavel">Responsável:</label>
        <select id="responsavel"><option value="">Carregando...</option></select>

        <div id="listaFerramentas"></div>

        <h3>Prévia da Câmera</h3>
        
        <button id="trocarCamera" onclick="trocarCamera()">Trocar Câmera</button>

        <div class="camera-control-area"> 
            <video id="video" autoplay playsinline></video> <div class="botoes-foto-container">
                <button onclick="tirarFoto('armario1')">Tirar Foto do Armário 1</button>
                <button onclick="tirarFoto('armario2')">Tirar Foto do Armário 2</button>
            </div>
        </div>
        
        <canvas id="canvas" width="300" height="200" style="display:none;"></canvas>
        
        <h4 style="margin-top: 20px;">Fotos Capturadas:</h4>
        
        <p id="confirmFoto1" class="foto-confirm">✅ Foto Armário 1 tirada!</p>
        <img id="previewFoto1" class="foto-preview" style="display: none;"/>

        <p id="confirmFoto2" class="foto-confirm">✅ Foto Armário 2 tirada!</p>
        <img id="previewFoto2" class="foto-preview" style="display: none;"/>

        <button onclick="finalizarChecklist()">Finalizar Checklist</button>
    </div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

// ======= Supabase (Chaves Anônimas) =======
const supabaseUrl = 'https://jyehccjogujkdtingplc.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imp5ZWhjY2pvZ3Vqa2R0aW5ncGxjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEzMDczODQsImV4cCI6MjA3Njg4MzM4NH0.1FHhPSRmZS2uw5f1tNqALeBqHMv4UfwmrGfnPBZsYME';
const supabase = createClient(supabaseUrl, supabaseKey);

let ferramentas = [];
let usuarios = [];
let locais = []; 
let fotoArmario1File = null; 
let fotoArmario2File = null; 
let cameraAtiva = false;

// === NOVAS VARIÁVEIS DE CÂMERA ===
let currentStream = null; // Guarda a stream atual para podermos pará-la
// Inicia com 'environment' (traseira) que é mais útil para checklist
let currentFacingMode = 'environment'; 

// =======================================================
// === Funções de Carga Simplificadas para Teste ===
// =======================================================

async function carregarLocais(){
    const { data, error } = await supabase.from('locais_checklist').select('*').order('nome');
    if(error) return console.error('Erro ao carregar locais:', error.message);
    locais = data || [];

    const selectChecklist = document.getElementById('localChecklist');
    selectChecklist.innerHTML='<option value="">Selecione o Local</option>';
    locais.forEach(l => {
        const option=document.createElement('option');
        option.value=l.id; 
        option.textContent=l.nome;
        selectChecklist.appendChild(option);
    });
}

async function carregarUsuarios(){
    const { data, error } = await supabase.from('usuarios').select('*').order('nome');
    if(error) return console.error('Erro ao carregar usuários: '+error.message);
    usuarios = data || [];

    const select = document.getElementById('responsavel');
    select.innerHTML='<option value="">Selecione o responsável</option>';
    usuarios.forEach(u=>{
        const option=document.createElement('option');
        option.value=u.nome;
        option.textContent=u.nome;
        select.appendChild(option);
    });
}

async function carregarFerramentas(){
    const { data, error } = await supabase.from('ferramentas').select('*').order('nome');
    if(error) return console.error('Erro ao carregar ferramentas: '+error.message);
    ferramentas = data || [];
}

// =======================================================
// ===================== Lógica de Câmera ================
// =======================================================

// === NOVA FUNÇÃO PARA INICIAR A CÂMERA ===
async function iniciarCamera(facingMode) {
    // Para a stream de vídeo anterior, se estiver ativa
    if (currentStream) {
        currentStream.getTracks().forEach(track => {
            track.stop();
        });
    }

    const video = document.getElementById('video');
    const constraints = {
        video: {
            facingMode: facingMode 
        }
    };

    try {
        const stream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = stream;
        currentStream = stream; // Salva a nova stream
        currentFacingMode = facingMode; // Salva o modo atual
    } catch (err) {
        console.error('Erro ao iniciar câmera:', err);
        // Se falhar (ex: 'environment' não existe no desktop), tenta a 'user'
        if (facingMode !== 'user') {
            console.warn('Falha ao abrir câmera ' + facingMode + ', tentando "user".');
            iniciarCamera('user'); // Tenta a câmera frontal como fallback
        } else {
            alert('Não foi possível acessar a câmera. Verifique as permissões.');
        }
    }
}

// === NOVA FUNÇÃO PARA TROCAR A CÂMERA ===
window.trocarCamera = function() {
    // Alterna entre 'user' (frontal) e 'environment' (traseira)
    const newFacingMode = (currentFacingMode === 'user') ? 'environment' : 'user';
    iniciarCamera(newFacingMode);
}


// =======================================================
// ===================== Checklist Lógica ================
// =======================================================

window.carregarChecklist = async function(){
    await carregarUsuarios();
    await carregarLocais(); 
    await carregarFerramentas();
    
    // Inicializa a exibição de ferramentas (vazia até selecionar o local)
    filtrarFerramentasPorLocal(); 

    // === LÓGICA DE CÂMERA MODIFICADA ===
    // Ativa a Câmera (só na primeira vez)
    if(!cameraAtiva){
        cameraAtiva = true;
        // Inicia com a câmera traseira (environment) por padrão
        iniciarCamera(currentFacingMode); 
    }
}

window.filtrarFerramentasPorLocal = function() {
    const container=document.getElementById('listaFerramentas');
    container.innerHTML='';
    const localId = document.getElementById('localChecklist').value;
    
    if (!localId) {
        container.textContent = 'Selecione um local para ver as ferramentas.';
        return;
    }

    const ferramentasFiltradas = ferramentas.filter(f => f.id_local == localId);

    if (ferramentasFiltradas.length === 0) {
         container.textContent = 'Nenhuma ferramenta cadastrada para este local.';
    }

    ferramentasFiltradas.forEach(f=>{
        const div=document.createElement('div');
        div.innerHTML=`<input type="checkbox" id="f${f.id}" data-id="${f.id}" checked> <label for="f${f.id}">${f.nome}</label>`;
        container.appendChild(div);
    });
};

window.tirarFoto=function(armario){
    const video=document.getElementById('video');
    const canvas=document.getElementById('canvas');
    const preview1=document.getElementById('previewFoto1');
    const confirm1=document.getElementById('confirmFoto1');
    const preview2=document.getElementById('previewFoto2');
    const confirm2=document.getElementById('confirmFoto2');

    const ctx=canvas.getContext('2d');
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const dataURL=canvas.toDataURL('image/png');
    
    fetch(dataURL).then(r=>r.blob()).then(blob=>{
        if(armario==='armario1'){
            fotoArmario1File=new File([blob],`foto1_${Date.now()}.png`,{type:'image/png'});
            preview1.src=dataURL;
            preview1.style.display='block';
            confirm1.style.display='block';
        } else if(armario==='armario2'){
            fotoArmario2File=new File([blob],`foto2_${Date.now()}.png`,{type:'image/png'});
            preview2.src=dataURL;
            preview2.style.display='block';
            confirm2.style.display='block';
        }
    });
};

window.finalizarChecklist=async function(){
    const responsavel=document.getElementById('responsavel').value;
    const localId = document.getElementById('localChecklist').value; 
    
    if(!responsavel) return alert('Selecione o responsável');
    if(!localId) return alert('Selecione o Local do Checklist!'); 
    
    if(!fotoArmario1File || !fotoArmario2File) return alert('É obrigatório tirar as duas fotos dos armários antes de finalizar.');

    const dataLocal = new Date().toISOString(); 
    
    // --- 1. REGISTRA CHECKLIST ---
    const { data: ckInsert, error: ckError } = await supabase.from('checklists')
        .insert([{ data: dataLocal, responsavel, id_local: localId }])
        .select('id');
    if(ckError) return alert('Erro ao registrar checklist: '+ckError.message);
    const ck=ckInsert[0];

    let updateFields = {};

    // --- 2. UPLOAD FOTO 1 ---
    const fotoPath1=`checklists/${ck.id}/foto1_${ck.id}.png`;
    const { error: upError1 } = await supabase.storage.from('fotos').upload(fotoPath1, fotoArmario1File, {upsert:true});
    if(!upError1) updateFields.foto_armario = fotoPath1;

    // --- 3. UPLOAD FOTO 2 ---
    const fotoPath2=`checklists/${ck.id}/foto2_${ck.id}.png`;
    const { error: upError2 } = await supabase.storage.from('fotos').upload(fotoPath2, fotoArmario2File, {upsert:true});
    if(!upError2) updateFields.foto_armario_2 = fotoPath2;

    // --- 4. ATUALIZA CHECKLIST COM OS CAMINHOS DAS FOTOS ---
    if(Object.keys(updateFields).length > 0) {
        const { error: updateError } = await supabase.from('checklists').update(updateFields).eq('id',ck.id);
        if(updateError) console.error('Erro ao atualizar fotos:', updateError.message);
    }

    // --- 5. REGISTRA STATUS DAS FERRAMENTAS ---
    const ferramentasDoLocal = ferramentas.filter(f => f.id_local == localId);
    
    const statusItens=ferramentasDoLocal.map(f=>{
        const check=document.querySelector(`#f${f.id}`);
        // Se o checkbox não for encontrado ou não estiver marcado, é ausente (false)
        const presente = check ? check.checked : false; 
        return {id_checklist:ck.id,id_ferramenta:f.id,presente:presente};
    });
    
    await supabase.from('itens_checklist').insert(statusItens);

    // --- 6. LIMPEZA E FEEDBACK ---
    alert('Checklist finalizado com sucesso! Dados e fotos registrados.');
    
    // Limpar estado
    fotoArmario1File=null;
    fotoArmario2File=null;
    document.getElementById('previewFoto1').style.display='none';
    document.getElementById('previewFoto2').style.display='none';
    document.getElementById('confirmFoto1').style.display='none';
    document.getElementById('confirmFoto2').style.display='none';
    document.getElementById('responsavel').value = '';
    document.getElementById('localChecklist').value = '';
    filtrarFerramentasPorLocal();
};
</script>
</body>
</html>
